<link rel="stylesheet" href="{$path}/res/css/slide-panel.css">
<link rel="stylesheet" href="{$path}/res/theme/material/base/assets/examples/css/apps/media.css">
<style>
.info-wrap .title {
	text-overflow: ellipsis;
    overflow: hidden;
}
.image-wrap {
	display: table-cell;
    vertical-align: middle;
}
</style>
<header class="slidePanel-header">
  <div class="overlay-top overlay-panel overlay-background bg-indigo-600">
    <div class="slidePanel-actions btn-group btn-group-flat" aria-label="actions" role="group">      
      <button type="button" class="btn btn-pure slidePanel-close icon md-close" aria-hidden="true"></button>
    </div>
    <h4 class="stage-name"><h5 class="taskboard-stage-title text-uppercase">Dados da postagem</h5></h4>
  </div>  
</header>
<div class="slidePanel-inner m-0 p-0 app-media">
	
	<div class="panel nav-tabs-horizontal nav-tabs-inverse" id="post-tabs" data-plugin="tabs">
	    <div class="panel-heading panel-heading-tab" id="tabs-post" style="border-radius: 0;">
	    </div>
	    <div class="panel-body p-t-20">
	      <div class="tab-content">
	        <div class="tab-pane active" id="tab-post" role="tabpanel">
	          <form asutocomplete="off" id="form-post" class="slidePanel-form">
			  	<div class="form-group form-material" data-plugin="formMaterial">
			      <label class="form-control-label" for="despost">Título</label>
			      <input type="text" class="form-control" name="destitle">
				</div>
				<div class="form-group form-material" data-plugin="formMaterial">
			      <label class="form-control-label" for="desurl">URL</label>
			      <select name="desurl" class="form-control" id="desurl"></select>
			    </div>
			    <div class="form-group form-material" data-plugin="formMaterial">
			      <label class="form-control-label" for="dtpublished">Data de Publicação</label>
			      <select name="dtpublished" class="form-control" id="dtpublished"></select>
			    </div>
			    <div class="form-group form-material row margin-top-10" data-plugin="formMaterial">
                    <div class="row-fluid">
                        <div class="col-xs-6">
                            <label class="control-label" for="idcover">Capa</label>
                            <button type="button" id="btn-cover" class="btn btn-primary">Alterar Capa</button>
                        </div>
                        <div class="col-xs-6">
                            <img class="img-rounded" id="idcover" width="150" height="150" src="{$path}/res/img/placeholder.png">
                        </div>
                    </div>
                </div>
			    <button type="submit" class="btn btn-block btn-primary" id="btn-post-salvar">Salvar</button>
			  </form>
	        </div>
	        <div class="tab-pane" id="tab-post-tags" role="tabpanel">
	        	<div class="panel">
		            <div class="panel-heading">
		              <!-- <div class="panel-actions panel-actions-keep">
		                <a id="btn-action-refresh" class="panel-action" href="#" aria-expanded="false" role="button"><i class="icon md-refresh" aria-hidden="true"></i></a>
		              </div> -->
		            </div>
		            <h5>Tags</h5>
                  	<ul class="p-10 ul-tags" style="list-style:none;">
	                </ul>
		        </div>
	          	
	        </div>
	        <div class="tab-pane" id="tab-post-categories" role="tabpanel">

				<div class="panel">
        			<div class="panel-heading">
        				
					</div>
					<h5>Categorias</h5>
                  	<ul class="p-10 ul-categories" style="list-style:none;">
	                </ul>
				</div>

				<!-- <div class="panel">
		            <div class="panel-heading">
		              <div class="btn-group" aria-label="Basic example" role="group">
	                    <button type="button" id="adicionar" class="btn btn-icon btn-success waves-effect">
	                    	<i class="icon md-upload"  aria-hidden="true"></i> Adicionar</button>
	                  </div>
		              <div class="panel-actions panel-actions-keep">
		                <a id="btn-action-refresh-photos" class="panel-action" href="#" aria-expanded="false" role="button"><i class="icon md-refresh" aria-hidden="true"></i></a>
		              </div>
		            </div>
		            <div class="media-list p-0 m-t-20 is-grid">
						<ul class="blocks blocks-100 blocks-xxl-4 blocks-xl-4 blocks-lg-4 blocks-md-4 blocks-sm-4" data-plugin="animateList" data-child=">li"></ul>
			        </div>
			    </div> -->
	        </div>
	      </div>
	    </div>
    </div>

</div>
<script id="tpl-tag" type="text/x-handlebars-template">
  <li data-idtag="{{idtag}}">
    <span class="checkbox-custom checkbox-primary checkbox-lg">
      <input type="checkbox" class="mailbox-checkbox selectable-item" id="mail_mid_1"
      />
      <label for="mail_mid_1">{{destag}}</label>
    </span>
  </li>
</script>

<script id="tpl-category" type="text/x-handlebars-template">
  <li data-idcategory="{{idcategory}}">
    <span class="checkbox-custom checkbox-primary checkbox-lg">
      <input type="checkbox" class="mailbox-checkbox selectable-item" id="mail_mid_1"
      />
      <label for="mail_mid_1">{{descategory}}</label>
    </span>
  </li>
</script>
<script>

var tpl = {
	tag:Handlebars.compile($("#tpl-tag").html()),
	category:Handlebars.compile($("#tpl-category").html())
};

var post = JSON.parse('{function="json_encode($post)"}');

function loadTags(){

	var $panel = System.getPanelApi($("#tab-post-tags .panel"));

	$panel.load();

	var $ul = $("#tab-post-tags ul");

	rest({
		url:PATH+"/blog-tags/all",
		success:function(r){

			$ul.html('');

			$.each(r.data, function(index, row){

				$li = $(tpl.tag(row));

				$ul.append($li);

				$.each(post.Tags, function(key, value){

					if(value.idtag == row.idtag){
						$li.find("[type=checkbox]").prop("selected", true);
					}

				});

			});

			$panel.done();

		},
		failure:function(r){
			$panel.done();
			System.showError(r);
		}
	});

}

function loadCategories(){

	var $panel = System.getPanelApi($("#tab-post-categories .panel"));

	$panel.load();

	var $ul = $("#tab-post-categories ul");

	rest({
		url:PATH+"/blog-categories/all",
		success:function(r){

			$ul.html('');

			$.each(r.data, function(index, row){

				$li = $(tpl.tag(row));

				$ul.append($li);

				$.each(post.Categories, function(key, value){

					if(value.idcategory == row.idcategory){
						$li.find("[type=checkbox]").prop("selected", true);
					}

				});

			});

			$panel.done();

		},
		failure:function(r){
			$panel.done();
			System.showError(r);
		}
	});

}

new Tab({
	id:"tabs-post",
	items:[{
		title:"Postagem",
		id:"tab-post"
	},{
		title:"Tags",
		id:"tab-post-tags"
	},{
		title:"Categorias",
		id:"tab-post-categories"
	}],
	listeners:{
		tabchange:function(object, event){

			switch (event.tabContent.id) {

				case 'tab-post-tags':
				loadTags();
				break;

				case 'tab-post-categories':
				loadCategories();
				break;

			}

		}
	}
});

$("#form-post").formLoad(post);
  
var form = $("#form-post");

form.form({
  resetForm:false,
  url:PATH+"/blog-posts",
  params:{
    idpost:post.idpost
  },
  success:function(){

    form.find("button#btn-post-salvar").btnload("unload");
    System.success("Postagem salva com sucesso");
    $(".slidePanel-close").trigger("click");

  },
  failure:function(r){

    form.find("button#btn-post-salvar").btnload("unload");
    System.showError(r);

  }
});

</script>