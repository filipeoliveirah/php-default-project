<style>
	.slidePanel-inner{
		overflow: overlay;
	}
</style>
<header class="slidePanel-header">
  <div class="overlay-top overlay-panel overlay-background bg-indigo-600">
    <div class="slidePanel-actions btn-group btn-group-flat" aria-label="actions" role="group">
      <button type="button" class="btn btn-pure slidePanel-close icon md-close" aria-hidden="true"></button>
    </div>
    <h4 class="stage-name"><h5 class="taskboard-stage-title text-uppercase">Dados de {$course.descourse}</h5></h4>
  </div>  
</header>
<div class="slidePanel-inner m-0 p-0">
    
	<div class="panel nav-tabs-horizontal nav-tabs-inverse" data-plugin="tabs">

	    <div class="panel-heading panel-heading-tab" id="tabs-course" style="border-radius: 0;">
	    </div>

        <div class="panel-body p-t-20">
          	<div class="tab-content">
	            <div class="tab-pane active" id="courseTab" role="tabpanel" aria-expanded="true">
					<form id="form-course">
						<input type="hidden" name="inremoved">

						<div class="row">

							<div class="form-group form-material col-md-6" data-plugin="formMaterial">
								<label class="form-control-label">Curso</label>
								<input type="text" name="descourse" class="form-control">
							</div>

							<div class="form-group form-material col-md-6" data-plugin="formMaterial">
								<label class="form-control-label">Título</label>
								<input type="text" name="destitle" class="form-control">
							</div>

						</div>

						<div class="row">

							<div class="form-group form-material col-md-4" data-plugin="formMaterial">
								<label class="form-control-label">Carga Horária</label>
								<input type="number" name="vlworkload" class="form-control">
							</div>

							<div class="form-group form-material col-md-4" data-plugin="formMaterial">
								<label class="form-control-label">Número de Aulas</label>
								<input type="number" name="nraulas" class="form-control">
							</div>

							<div class="form-group form-material col-md-4" data-plugin="formMaterial">
								<label class="form-control-label">Número de Exercícios</label>
								<input type="number" name="nrexercises" class="form-control">
							</div>

						</div>

						<div class="form-group form-material" data-plugin="formMaterial">
							<label class="form-control-label">Descrição</label>
							<div id="summernote"></div>
						</div>

						<div class="form-group form-material" data-plugin="formMaterial">
							<button type="submit" class="btn btn-primary waves-effect">Salvar</button>
						</div>
					</form>
	            </div>
				<!-- terminando os dados do curso -->

				<!-- iniciando as seções do curso -->
	            <div class="tab-pane" id="sectionsTab" role="tabpanel" aria-expanded="true">

	            	<button type="button" class="btn btn-success btn-criar-section">Criar Seção</button>

					<div id="sections" class="panel m-t-20">
						
						<table class="table table-stripped table-hover">
							
						</table>

					</div>

	            </div>
	        </div>
        </div>

	</div>

 </div>

 <div class="modal fade" id="modalSectionCriar" data-backdrop="false"  tabindex="-1" role="dialog">
  	<div class="modal-dialog" role="document">
    	<div class="modal-content">
	      	<div class="modal-header">		        
		        <h4 class="modal-title">Criar seção</h4>
	      	</div>
	      	<form>
		      	<div class="modal-body">

		      		<div class="row">
		        		
			        	<div class="form-group form-material col-md-6" data-plugin="formMaterial">
			        		<label class="form-control-label">Nome</label>
							<input type="text" name="dessection" class="form-control">
			        	</div>

			        	<div class="form-group form-material col-md-6" data-plugin="formMaterial">
			        		<label class="form-control-label">Ordem</label>
							<input type="number" name="nrordem" class="form-control">
			        	</div>

			        </div>

		      	</div>
		      	<div class="modal-footer">
			        <div class="form-group form-material" data-plugin="formMaterial">
			        	<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
			    		<button type="submit" class="btn btn-primary">Salvar</button>
			    	</div>
			    </div>

			</form>
      
   		</div><!-- /.modal-content -->
  	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="modalCurriculumCriar" data-backdrop="false"  tabindex="-1" role="dialog">
  	<div class="modal-dialog" role="document">
    	<div class="modal-content">
	      	<div class="modal-header">
		        <h4 class="modal-title">Criar currículo</h4>
	      	</div>
	      	<form>
		      	<div class="modal-body">

		      		<div class="row">
		        		
			        	<div class="form-group form-material col-md-6" data-plugin="formMaterial">
			        		<label class="form-control-label">Nome</label>
							<input type="text" name="descurriculum" class="form-control">
			        	</div>

			        	<div class="form-group form-material col-md-6" data-plugin="formMaterial">
			        		<label class="form-control-label">Ordem</label>
							<input type="number" name="nrordem" class="form-control">
			        	</div>

			        </div>

		        	<div class="form-group form-material" data-plugin="formMaterial">
		        		<label class="form-control-label">Descrição</label>
						<div id="summernote-curriculum"></div>
		        	</div>

		      	</div>
		      	<div class="modal-footer">
			        <div class="form-group form-material" data-plugin="formMaterial">
			        	<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
			    		<button type="submit" id="btn-curriculum-salvar" class="btn btn-primary">Salvar</button>
			    	</div>
			    </div>

			</form>
      
   		</div><!-- /.modal-content -->
  	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

 <script id="tpl-course-section-curriculum" type="text/x-handlebars-template">
 	<tr>
		<td>&nbsp;</td>
		<td><input type="text" name="descurriculum" class="form-control" value="{{descurriculum}}"></td>
		<td><button type="button" class="btn btn-success btn-outline input-search-close icon md-check curriculum-salvar" style="padding:10px"></button>
        <button type="button" class="btn btn-danger btn-outline input-search-close icon md-close-circle" style="padding:10px"></button></td>
	</tr>
 </script>

 <script id="tpl-course-section" type="text/x-handlebars-template">
 	<tbody class="table-section" data-plugin="tableSection">
	 	<tr>
			<td><i class="table-section-arrow"></i></td>
			<td>{{dessection}}</td>
			<td>
				<button type="button" class="btn btn-pure btn-success icon md-plus curriculum-criar" title="Adicionar currículo" style="padding:10px"></button>
				<button type="button" class="btn btn-danger btn-outline input-search-close icon md-delete section-remove" style="padding:10px"></button>
			</td>
		</tr>
	</tbody>
 </script>

 <script>

 var course = JSON.parse('{function="json_encode($course)"}');

 var tpl = {
 	courseSection:Handlebars.compile($("#tpl-course-section ").html()),
 	courseCurriculum:Handlebars.compile($("#tpl-course-section -curriculum").html())
 };

 var $panelSections = System.getPanelApi($("#sections"));

 var isSectionsLogged = false;

 function loadSections(){

 	if(isSectionsLogged === false){

 		var $panel = $("#sections table");				 	 		

	 	$panelSections.load();

	 	rest({
	 		url:PATH+"/courses/"+course.idcourse+"/sections",
	 		success:function(r){

	 			$panel.html('');	 			

	 			$.each(r.dataSections, function(index, section){

					var $row = $(tpl.courseSection(section));

					$panel.append($row);

					$row.after("<tbody></tbody>");

					if(r.dataCurriculums.length > 0){						

						$.each(r.dataCurriculums, function(index, curriculum){

							if(section.idsection == curriculum.idsection){		 					

								var $tr = $(tpl.courseCurriculum(curriculum));							
								$row.next('tbody').append($tr);

								$tr.find(".curriculum-salvar").on("click", function(){

									var $btn = $(this);

									$btn.btnload("load");

									rest({
										url:PATH+"/courses-curriculums",
										method:"POST",
										data:{
											idcurriculum:curriculum.idcurriculum,
											descurriculum:$tr.find("[name=descurriculum]").val(),
											desdescription:curriculum.desdescription.toString(),
											idsection:curriculum.idsection,
											nrordem:curriculum.nrordem
										},
										success:function(){
											$btn.btnload("unload");
										},
										failure:function(r){
											System.showError(r);
										}
									});

								});

				 				$tr.find(".btn-danger").on("click", function(){

				 					var $btn = $(this);

				 					$btn.btnload("load");

				 					rest({
				 						url:PATH+"/courses-curriculums/"+curriculum.idcurriculum,
				 						method:"DELETE",
				 						success:function(){
				 							$btn.btnload("unload");
				 							$tr.remove();
				 						},
				 						failure:function(r){
				 							System.showError(r);
				 							$btn.btnload("unload");
				 						}
				 					});

				 				});

							}

						});

					}

					$row.find(".curriculum-criar").on("click", function(){

						$("#summernote-curriculum").summernote({
							height:100
						});

						var $modalCurriculum = $("#modalCurriculumCriar");

						$modalCurriculum.modal("show").on("shown.bs.modal", function(){
							$modalCurriculum.find("[name=descurriculum]").focus();
						});

						var $btn = $modalCurriculum.find("[type=submit]");

						$modalCurriculum.find("form").form({					
							url:PATH+"/courses-curriculums",
							params:{
								idcurriculum:0,
								idsection:section.idsection
							},
							beforeParams: function() {

						        return {
						            desdescription: $('#summernote-curriculum').next('.note-editor').find('.note-editable').html()
						        };

						    },					
							success:function(){						
								$btn.text("Salvar");
								$('#summernote-curriculum').next('.note-editor').find('.note-editable').html('');
								$modalCurriculum.modal("hide");
								isSectionsLogged = false;
								loadSections();
							}

						});

					});

					$row.find(".section -remove").on("click", function(){

						var $btn = $(this);

						$btn.btnload("load");

						rest({
							url:PATH+"/courses-sections/"+section.idsection,
							method:"DELETE",
							success:function(){
								$btn.btnload("unload");								
								$row.next('tbody').remove();								
								$row.remove();
							},
							failure:function(r){
								System.showError(r);
								$btn.btnload("unload");
							}
						});

					});

	 			});

	 			$(".btn-criar-section").on("click", function(){

 					var $modal = $("#modalSectionCriar");

 					$modal.modal('show');

 					$modal.find("form").form({
 						url:PATH+"/courses-sections",
 						params:{
 							idsection:0,
 							idcourse:course.idcourse
 						},
 						success:function(r){
 							$modal.find("[type=submit]").text("Salvar");
 							$modal.modal("hide");
 							isSectionsLogged = false;
 							loadSections();
 						}
 					});

 				});

	 			$panelSections.done();

	 			isSectionsLogged = true;

	 		},
	 		failure:function(r){
	 			System.showError(r);
	 			$panelSections.done();
	 		}
	 	});

	}

 }

 function getHTML(idcourse){

 	rest({
 		url:PATH+"/courses/"+idcourse+"/html",
 		success:function(r){

 			var $summernote = $("#summernote");
 			$summernote.html(r.data);
 			$summernote.summernote({
 				height:200
 			});

 		}
 	})

 }

 getHTML(course.idcourse);

 new Tab({
 	id:"tabs-course",
 	items:[{
 		title:"Dados",
 		id:"courseTab"
 	},
 	{
 		title:"Seções",
 		id:"sectionsTab"
 	}],
 	listeners:{
 		tabchange:function(object, event){

 			switch(event.tabContent.id){

 				case "sectionsTab":
 				loadSections();

 				break;

 			}

 		}
 	}
 });

 var form = $("#form-course");

 form.formLoad(course);

 form.form({
 	url:PATH+"/courses",
 	resetForm:false,
 	params:{
 		idcourse:course.idcourse
 	},
	beforeParams: function() {

        return {
            desdescription: $('#summernote').next('.note-editor').find('.note-editable').html()
        };

    },
 	success:function(){
 		System.success("Curso salvo com sucesso");
 		$(".slidePanel-close").trigger("click");
 		$("#form-filtros [type=submit]").trigger("click");
 	},
 	failure:function(r){
 		System.showError(r);
 	}
 });

 </script>