<style>
  @media (max-width: 768px) {
    .p-xs-25 {
      padding: 25px!important;
    }
  }
  #btn-person-edit {
    z-index: 999999;
    position: relative;
    margin: 25px;
  }
</style>
<div id="person-panel">
  <header class="slidePanel-header">
    <div class="overlay-top overlay-panel overlay-background bg-indigo-600">
      <div class="slidePanel-actions btn-group btn-group-flat" aria-label="actions" role="group">
        <button id="btn-delete-person" type="button" class="btn btn-pure icon md-delete waves-effect" aria-hidden="true"></button>
        <button id="btn-close-slidepanel" type="button" class="btn btn-pure slidePanel-close icon md-close" aria-hidden="tr//reue"></button>
      </div>
      <h4 class="stage-name"><h5 class="taskboard-stage-title text-uppercase">{$person.desperson}</h5></h4>
    </div>  
  </header>
  <div class="slidePanel-inner p-0">
    <section class="slidePanel-inner-section p-0 m-0">
      
      <div class="panel nav-tabs-horizontal nav-tabs-inverse" id="person-tabs" data-plugin="tabs">
        <div class="panel-heading panel-heading-tab" style="border-radius: 0;" id="tabs-persons">
        </div>
        <div class="panel-body p-0">
          <div class="tab-content">
            <div class="tab-pane" id="tab-person-edit" role="tabpanel">
              <form id="form-person-edit">
                <input type="hidden" name="idperson">
                <div class="panel m-0" style="box-shadow:none">
                  <div class="panel-body p-y-0 p-t-20">
                    
                    <div class="panel-heading" style="height:  30px;">
                      <div class="panel-actions panel-actions-keep">
                        <a id="btn-actions-refresh" class="panel-action icon md-refresh-alt" aria-hidden="true" style="font-size:16px;"></a>
                        <a id="btn-actions-close" class="panel-action icon md-close" aria-hidden="true" style="font-size:16px;"></a>
                      </div>
                    </div>

                    <div class="row">
                      <div class="form-group col-xs-12 col-md-4">
                        <label class="form-control-label" for="desperson">Nome do cliente <span class="red-900">*</span></label>
                        <input type="text" class="form-control" id="desperson" name="desperson">
                      </div>
                      <div class="form-group col-xs-12 col-md-4">
                        <label class="form-control-label" for="dessex">Sexo</label>
                        <select class="form-control" id="dessex" name="dessex">
                          <option value="M">Masculino</option>
                          <option value="F">Feminino</option>
                        </select>
                      </div>
                      <div class="form-group col-xs-12 col-md-4">
                        <label class="form-control-label" for="idpersontype">Tipo</label>
                        <select class="form-control" id="idpersontype" name="idpersontype"></select>
                      </div>
                    </div>
                    
                    <div id="register-person-fisica">
                      <div class="row">
                        
                        <div class="form-group col-xs-12 col-md-4">
                          <label class="form-control-label" for="descpf">CPF</label>
                          <input type="text" class="form-control" id="descpf" name="descpf">
                        </div>
                        <div class="form-group col-xs-12 col-md-4">
                          <label class="form-control-label" for="desrg">RG</label>
                          <input type="text" class="form-control" id="desrg" name="desrg">
                        </div>
                        <div class="form-group col-xs-12 col-md-4">
                          <label class="form-control-label" for="dtbirth">Data de Nascimento</label>
                          <input type="date" class="form-control" id="dtbirth" name="dtbirth">
                        </div>
                      </div>
                      <div class="row">
                        <div class="form-group col-xs-12 col-md-6">
                          <label class="form-control-label" for="desemail">Email</label>
                          <input type="email" class="form-control" id="desemail" name="desemail">
                        </div>
                        <div class="form-group col-xs-12 col-md-3">
                          <label class="form-control-label" for="desphonecomercial">Telefone comercial</label>
                          <input type="tel" class="form-control" id="desphonecomercial" name="desphonecomercial">
                        </div>
                        <div class="form-group col-xs-12 col-md-3">
                          <label class="form-control-label" for="descellphone">Telefone celular</label>
                          <input type="tel" class="form-control" id="descellphone" name="descellphone">
                        </div>
                      </div>
                    </div>

                    <div id="register-person-juridica" class="hide">
                      
                    </div>                    

                  </div>
                </div>
                <div class="p-25">
                  <button type="submit" class="btn btn-primary btn-block waves-effect">Salvar Dados</button>
                </div>
              </form>
            </div>
            <div class="tab-pane" id="tab-person-home" role="tabpanel">.
              
              <button id="btn-person-edit" class="btn btn-primary pull-xs-right waves-effect"><i class="icon md-edit" aria-hidden="true"></i> edit</button>

              <div class="card"></div>

            </div>
            <div class="tab-pane" id="tab-person-sitecontact" role="tabpanel">
              <div class="panel">
                <div class="panel-body" data-auto-height="-288">
                  <div class="chat-box">
                    <div class="chats">
                      
                    </div>
                  </div>
                </div>
                <div class="panel-footer">
                  <form>
                    <div class="input-group form-material">
                      <span class="input-group-btn">
                        <a href="javascript: void(0)" class="btn btn-pure btn-default icon md-camera"></a>
                      </span>
                      <input class="form-control" type="text" placeholder="Type message here ...">
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-pure btn-default icon md-mail-send"></button>
                      </span>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <div class="tab-pane" id="tab-person-orders" role="tabpanel">
              
              <div class="panel">
                <div class="panel-heading">
                  <h3 class="panel-title indigo-500">Ãšltimas vendas</h3>
                  <div class="panel-actions">
                    <div class="row-fluid">
                      <div class="col-xs-6">
                        <select class="form-control pull-xs-right" name="idnegotiation"></select>
                      </div>
                      <div class="col-xs-6">
                        <a class="panel-action icon md-refresh-alt pull-xs-right" id="btn-order-reload" aria-hidden="true"></a>
                      </div>
                    </div>
                  </div>
                </div>
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Venda</th>
                      <th>Total (R$)</th>
                    </tr>
                  </thead>
                  <tbody>
                    
                  </tbody>
                </table>
                <div class="panel-footer">
                  <div class="pagination"></div>
                </div>
              </div>
              
            </div>
            <div class="tab-pane" id="tab-person-log" role="tabpanel">
              
              <div class="panel">

                <table class="table table-hover">
                  
                  <thead>
                    <tr>
                      <th>Log</th>
                      <th>Tipo</th>
                      <th>Data de cadastro</th>
                    </tr>  
                  </thead>

                  <tbody>
                    
                  </tbody>

                </table>

                <div class="panel-footer">
                  <div id="pagination"></div>
                </div>
                
              </div>

            </div>
            <div class="tab-pane" id="tab-person-files" role="tabpanel">
              
              <div class="panel">
                <div class="panel-heading">
                  <div class="m-10 btn-group btn-group-flat">
                    <button id="btn-person-files-upload" type="button" class="btn btn-icon btn-success waves-effect"><i class="icon md-upload" aria-hidden="true"></i> Adicionar</button>
                    <button id="btn-person-files-remove" type="button" class="btn btn-icon btn-danger waves-effect m-l-15" disabled="disabled"><i class="icon md-delete" aria-hidden="true"></i> Excluir</button>
                  </div>
                  <div class="panel-actions">
                    <a id="btn-person-files-reload" class="panel-action icon md-refresh-alt" aria-hidden="true"></a>
                  </div>
                </div>
                <div class="panel-body p-b-0">
                  <ul class="blocks blocks-100 blocks-xxl-5 blocks-xl-5 blocks-lg-5 blocks-md-4 blocks-sm-5" data-plugin="animateList" data-child=">li"></ul>
                </div>
                <div class="panel-footer">
                  <div class="pagination"></div>
                </div>
              </div>
  
            </div>

            <!-- inicio da tab de edit address -->
            <div class="tab-pane panel" id="tab-address-edit" role="tabpanel">

              <div class="panel-body">
                  
                <div class="panel-heading" style="height:  30px;">
                  <div class="panel-actions panel-actions-keep">
                    <a id="btn-actions-address-close" class="panel-action icon md-close" aria-hidden="true" style="font-size:16px;"></a>
                  </div>
                </div>

                <form id="form-addresses">
                
                </form>

              </div>             

            </div>

            <!-- inicio da tab que lista os addresses -->
            <div class="tab-pane" id="tab-person-addresses" role="tabpanel">

              <div class="panel">

                <div class="panel-body panel-primary panel-line p-b-0 m-0">

                  <div class="btn-group open">
                    <button type="button" class="btn btn-success pull-xs-left waves-effect btn-address-add" id="dropdownAddress" data-toggle="dropdown" aria-expanded="true">
                      <i class="icon md-plus" aria-hidden="true"></i> adicionar
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownAddress" role="menu">
                      {loop="$addressesTypes"}
                        <a class="dropdown-item" href="javascript:void(0)" role="menuitem" data-idaddresstype="{$value.idaddresstype}">{$value.desaddresstype}</a>
                      {/loop}
                    </div>
                  </div>

                  <table class="table table-stripped table-hover m-t-15">
                    <tbody>
                      
                    </tbody>
                  </table>
                </div>

              </div>
            </div>

            <div class="tab-pane" id="tab-person-address-add" role="tabpanel">
              
              <div class="panel" id="address-add">

                <div class="panel-body panel-primary panel-line p-b-0 m-0">
                  <div class="panel-heading" style="height: 30px;">
                    <div class="panel-actions panel-actions-keep">
                      <a id="btn-actions-address-add-close" class="panel-action icon md-close" aria-hidden="true" style="font-size:16px;"></a>
                    </div>
                  </div>

                  <form>

                      <div class="row">
                        <div class="form-group col-xs-12 col-md-3">
                          <input type="hidden" name="idaddress">
                          <input type="hidden" name="idaddresstype">
                          <label class="form-control-label" for="descep">CEP</label>
                          <input type="text" class="form-control" id="descep" name="descep">
                        </div>
                        <div class="form-group col-xs-12 col-md-6">
                          <label class="form-control-label" for="desaddress">EndereÃ§o</label>
                          <input type="text" class="form-control" id="desaddress" name="desaddress">
                        </div>
                        <div class="form-group col-xs-12 col-md-3">
                          <label class="form-control-label" for="desnumber">NÃºmero</label>
                          <input type="text" class="form-control" id="desnumber" name="desnumber">
                        </div>
                      </div>
                      <div class="row">
                        <div class="form-group col-xs-12 col-md-3">
                          <label class="form-control-label" for="descomplement">Complemento</label>
                          <input type="text" class="form-control" id="descomplement" name="descomplement">
                        </div>
                        <div class="form-group col-xs-12 col-md-4">
                          <label class="form-control-label" for="desdistrict">Bairro</label>
                          <input type="text" class="form-control" id="desdistrict" name="desdistrict">
                        </div>
                        <div class="form-group col-xs-12 col-md-5">          
                            <label class="form-control-label" for="descity">Cidade</label>
                            <input type="text" class="form-control" id="descity" name="descity">
                            <input type="hidden" name="desuf">
                        </div>
                        <div class="input-group">
                          <span class="input-group-btn pull-xs-right m-r-60" style="vertical-align:bottom;">
                            <button type="button" class="btn btn-success btn-outline input-search-close icon wb-plus-circle" style="padding:10px"></button>
                          </span>
                        </div>
                      </div>
                    
                  </form>

                </div>
                  
              </div>

            </div>
            <!-- fim da tab de addresses -->

            <!-- start of tab that list the categories  -->
            <div class="tab-pane" id="tab-person-categories" role="tabpanel">

              <div class="panel">

                <div class="panel-body panel-primary panel-line p-b-0 m-0">                 

                  <ul class="list-group">
                    
                  </ul>
                  
                </div>

              </div>
            </div>

          </div>
        </div>
      </div>
      
    </section>
  </div>
</div>
{noparse}
<script id="tpl-person-order-row" type="text/x-handlebars-template">
  <tr>
    <td>{{desdtregister}}</td>
    <td>{{idorder}}</td>
    <td class="real">{{desvltotal}}</td>
  </tr>
</script>

<script id="tpl-person-home-card" type="text/x-handlebars-template">
<div class="card-header bg-white p-30 clearfix">
  <a id="person-photo" class="avatar avatar-100 pull-xs-left m-r-20" href="javascript:void(0)">
    <img src="{{desphotourl}}" alt="Foto de {{desprimeironome}}">
  </a>
  <div class="pull-xs-left">
    <div class="font-size-20 m-b-15">{{desperson}}</div>
    {{#if incliente}}
    <span class="tag tag-outline tag-primary">Cliente</span>
    {{/if}}
    {{#if infornecedor}}
    <span class="tag tag-outline tag-dark">Fornecedor</span>
    {{/if}}
    {{#if incolaborador}}
    <span class="tag tag-outline tag-success">Colaborador</span>
    {{/if}}
    {{#if address.desaddressresumido}}
    <p class="m-b-5 text-nowrap"><i class="icon md-pin m-r-10" aria-hidden="true"></i>
      <span class="text-break">{{address.desaddressresumido}}</span>
    </p>
    {{/if}}
    {{#if desemail}}
    <p class="m-b-5 text-nowrap"><i class="icon md-email m-r-10" aria-hidden="true"></i>
      <span class="text-break">{{desemail}}</span>
    </p>
    {{/if}}
    {{#if cpf.desdocumentformatted}}
    <p class="m-b-5 text-nowrap"><i class="icon md-balance-wallet m-r-10" aria-hidden="true"></i>
      <span class="text-break">{{cpf.desdocumentformatted}}</span>
    </p>
    {{/if}}
    {{#if cnpj.desdocumentformatted}}
    <p class="m-b-5 text-nowrap"><i class="icon md-balance-wallet m-r-10" aria-hidden="true"></i>
      <span class="text-break">{{cnpj.desdocumentformatted}}</span>
    </p>
    {{/if}}
  </div>
</div>
</script>

<script id="tpl-person-file" type="text/x-handlebars-template">
<li class="animation-scale-up masonry-item" style="animation-fill-mode: backwards; animation-duration: 250ms; animation-delay: 0ms;">
  <div class="media-item">
    <div class="checkbox-custom checkbox-primary checkbox-lg">
      <input type="checkbox" class="selectable-item" id="media_1" data-idfile="{{idfile}}" />
      <label for="media_1"></label>
    </div>
    <div class="image-wrap">
      <img class="image img-rounded" src="{{desthumb}}" alt="{{desalias}}">
    </div>
    <div class="info-wrap">
      <div class="title">{{desalias}}</div>
    </div>
  </div>
</li>
</script>

<script id="tpl-person-addresses" type="text/x-handlebars-template">
  <tr>
    <td>
      <p>{{desaddress}}, {{desnumber}} - {{descity}} - {{descep}}</p>
      <p><small>{{desaddresstype}}</small></p>
    </td>
    <td>
      <button class="btn btn-danger pull-xs-right waves-effect icon md-delete"></button>
      <button class="btn-address-edit m-l-10 btn btn-primary pull-xs-right waves-effect icon md-edit"></button>
    </td>
  </tr>
</script>

<script id="tpl-person-address" type="text/x-handlebars-template">
  <div class="panel">

    <div class="panel-body panel-primary panel-line p-b-0 m-0">
      <div class="panel-heading">
        <div class="row">
          <div class="col-md-5">
            <h3 class="panel-title p-l-0"><select name="idaddresstype" class="form-control"></select></h3>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="form-group col-xs-12 col-md-3">
          <input type="hidden" name="idaddress" value="{{idaddress}}">
          <label class="form-control-label" for="descep">CEP</label>
          <input type="text" class="form-control" id="descep" name="descep" value="{{descep}}">
        </div>
        <div class="form-group col-xs-12 col-md-6">
          <label class="form-control-label" for="desaddress">EndereÃ§o</label>
          <input type="text" class="form-control" id="desaddress" name="desaddress" value="{{desaddress}}">
        </div>
        <div class="form-group col-xs-12 col-md-3">
          <label class="form-control-label" for="desnumber">NÃºmero</label>
          <input type="text" class="form-control" id="desnumber" name="desnumber" value="{{desnumber}}">
        </div>
      </div>
      <div class="row">
        <div class="form-group col-xs-12 col-md-3">
          <label class="form-control-label" for="descomplement">Complemento</label>
          <input type="text" class="form-control" id="descomplement" name="descomplement" value="{{descomplement}}">
        </div>
        <div class="form-group col-xs-12 col-md-4">
          <label class="form-control-label" for="desdistrict">Bairro</label>
          <input type="text" class="form-control" id="desdistrict" name="desdistrict" value="{{desdistrict}}">
        </div>
        <div class="form-group col-xs-12 col-md-5">          
            <label class="form-control-label" for="descity">Cidade</label>
            <input type="text" class="form-control" id="descity" name="descity" value="{{descity}}">
            <input type="hidden" name="desuf">            
        </div>
        <div class="input-group">
          <span class="input-group-btn pull-xs-right m-r-60" style="vertical-align:bottom;">
            <button type="button" class="btn btn-danger btn-outline input-search-close icon md-delete" style="padding:10px"></button>
            <button type="button" class="btn btn-success btn-outline input-search-close icon wb-plus-circle" style="padding:10px"></button>
          </span>
        </div>
      </div>
    </div>
  </div>
</script>
<script id="tpl-person-sitecontact-row" type="text/x-handlebars-template">
  <div class="chat">
    <div class="chat-avatar">
      <a class="avatar" data-toggle="tooltip" href="#" data-placement="right" title="{{desperson}}">
        <img src="{{desphotourl}}" alt="{{desperson}}">
      </a>
    </div>
    <div class="chat-body">
      <div class="chat-content">
        <p>{{desmessage}}</p>
        <time class="chat-time" datetime="{{dtregister}}">8:30 am</time>
      </div>
    </div>
  </div>
</script>
<script id="tpl-person-category" type="text/x-handlebars-template">
  <li class="list-group-item">
    <div class="checkbox-custom checkbox-primary checkbox-lg">
      <input type="checkbox" class="selectable-item" id="media_1" data-idcategory="{{idcategory}}" />
      <label for="media_1"></label>
      {{descategory}}
    </div>    
  </li>
</script>
<script id="tpl-person-log" type="text/x-handlebars-template">
  <tr>
    <td>{{deslog}}</td>
    <td>{{deslogtype}}</td>
    <td>{{desdtregister}}</td>
  </tr>
</script>
{/noparse}
<script>

var personPanel = (function(data, selectorContainer, opts){

  var t = this;

  var defaults = {
    debug:false
  };

  var o = $.extend({}, defaults, opts);

  t.$el = $(selectorContainer);
  t.id = 0;
  t.pagination = {};
  t.limit = 10;

  t.setData = function(person){

    t.data = person;
    t.$el.trigger('person-change');

  };

  t.getData = function(){

    return t.data;

  };

  t.getTpl = function(id){

    return Handlebars.compile($("#"+id).html());

  };

  t.setCard = function(){

    var tpl = t.getTpl('tpl-person-home-card');
    var $render = $(tpl(t.getData()));

    t.$el.find('#tab-person-home').find('.card').html($render);

  };

  t.formatCep = function(cep){

    return (cep)?cep.substring(0, 5)+"-"+cep.substring(5):'';

  }

  t.$el.on('person-change', function(){

    var person = t.getData();

    person.descep = t.formatCep(person.descep);

    t.$el.find('#form-person-edit').formLoad(person);
    t.setCard(t.getData());

  });
  
  t.setData(person);

  t.getIdperson = function(){

    return t.getData().idperson;

  };

  t.deletePerson = function(){

    System.confirm("Deseja realmente excluir o register de "+data.desperson+" definitivamente? Todos os dados associados serÃ£o excluÃ­dos.", function(r, s, f){

      if (r) {

        rest({
          url:PATH+"/persons/"+t.getIdperson(),
          method:"DELETE",
          success:function(){
            s();
            data = {};
            $("#btn-close-slidepanel").trigger("click");
          },
          failure:function(e){
            System.showError(e);
            f(e.error);
          }
        });

      } else {

        f();

      }

    });

  };

  t.uploadPhoto = function(){

    $.upload({
      url:PATH+"/persons/"+t.getIdperson()+"/photo",
      success:function(r){

        if (r.data.length) t.setData(r.data[0]);

      },
      failure:function(e){
        System.showError(e);
      }
    });

  };

  t.setTabActive = function(id){

    $('#person-tabs .tab-content .tab-pane').removeClass('active');
    $('#person-tabs .tab-content .tab-pane#'+id).addClass('active');
    $('#person-tabs [role="tab"]').removeClass('active');
    $('#person-tabs [role="tab"][href="#'+id+'"]').addClass('active');

  };

  t.initFieldClassEmpty = function(){

    t.$el.find('input').on('change', function(){
      if ($(this).val().length) {
        $(this).removeClass('empty');
      } else {
        $(this).addClass('empty');
      }
    });

  };

  t.initFieldCPF = function(){

    t.$el.find('[name=descpf]').on('change keyup', function(e){

      if (!$(this).val()) {

        var $formGroup =  t.$el.find('[name=descpf]').closest('.form-group');
        $formGroup.removeClass('has-success has-danger');

      }

    }).formValueCheck({
      url:PATH+"/documents/cpf",
      icon:'md-check',
      minLengthSubmit:11,
      success:function(r){
        
        var $formGroup =  t.$el.find('[name=descpf]').closest('.form-group');
        $formGroup.removeClass('has-success has-danger');

        if (r.incpf) {

          $formGroup.addClass('has-success');

        } else {

          $formGroup.addClass('has-danger');

        }

      }
    });

  };

  t.initFieldPersonType = function(){

    t.$el.find("[name=idpersontype]").combobox({
      url:PATH+"/persons-types",
      displayField:"despersontype",
      valueField:"idpersontype",
      value:1
    });

  };

  t.initFormPersonEdit = function(){

    t.$el.find('#form-person-edit').form({
      url:PATH+"/persons",
      resetForm:false,
      success:function(r){

        t.setData(r.data);
        System.success('Dados salvos com sucesso!');
        t.refreshList();

      }
    });

  };

  t.reload = function(callback){

    rest({
      url:PATH+"/persons/"+t.getIdperson(),
      success:function(r){

        t.setData(r.data);
        if (typeof callback === 'function') callback();

      },
      failure:function(e){

        System.showError(e);

      }
    });

  };

  t.refreshList = function(){

    if (typeof atualizarPagina === 'function') atualizarPagina();

  };

  t.saveAddress = function($row, callback = function(){}){

    rest({
      url:PATH+"/persons",
      method:"POST",
      data:{
        idperson:t.getIdperson(),
        idpersontype:t.getData().idpersontype,
        idaddress:$row.find("[name=idaddress]").val(),
        idaddresstype:$row.find("[name=idaddresstype]").val(),
        desaddress:$row.find("[name=desaddress]").val(),
        descep:$row.find("[name=descep]").val(),
        desnumber:$row.find("[name=desnumber]").val(),
        descomplement:$row.find("[name=descomplement]").val(),
        desdistrict:$row.find("[name=desdistrict]").val(),
        descity:$row.find("[name=descity]").val(),
        desuf:$row.find("[name=desuf]").val()
      },
      success:function(){
        if(typeof callback == 'function') callback();
      },
      failure:function(r){
        System.showError(r);
        
      }
    });

  }

  t.renderAddress = function(data){

    var tplAddress = t.getTpl("tpl-person-address");

    var $panel = System.getPanelApi(t.$el.find("#tab-address-edit"));

    $panel.load();

    var $form = t.$el.find("#tab-address-edit form#form-addresses");

    $form.html('');

    data.descep = t.formatCep(data.descep);

    var $row = $(tplAddress(data));

    $form.append($row);

    $panel.done();

    $row.find("[name=idaddresstype]").combobox({
      url:PATH+"/addressestypes",
      displayField:"desaddresstype",
      valueField:"idaddresstype",
      value:data.idaddresstype
    }).on("change", function(){
      t.saveAddress($row);            
    });

    $row.find('[name=descity]').combobox({
      url:PATH+"/addresses/citys",
      autoComplete:true,
      displayField:'descity',
      displayFieldRight:'desuf',
      valueField:'idcity',
      submitValue:true,
      hiddenName:'idcity'
    });

    $row.find("[name=descity]").trigger("change");

    $row.find('[name=descep]').formValueCheck({
      url:PATH+"/addresses/cep",
      success:function(r){

        $.each(r, function(chave, value){
          
          $.each(data, function(index, valor){
            
            if(chave == index){
              data[index] = value;
              $row.find("[name="+index+"]").val(value);
            }

          });

        });

        $row.find("[name=desuf]").val(r.desuf);
        $row.find("[name=descity]").trigger("change");
        $row.find("[name=desnumber]").trigger("focus");

      }
    });

    $row.find(".btn-success").on("click", function(){

      var $btn = $(this);

      $btn.btnload("load");

      t.saveAddress($row, function(){});

      $btn.btnload("unload");

    });

    $row.find(".btn-danger").on("click", function(){

      var $btn = $(this);

      $btn.btnload("load");

      rest({
        url:PATH+"/admin/addresses/"+row.idaddress,
        method:"DELETE",
        success:function(){
          $btn.btnload("unload");
          $row.remove();
        },
        failure:function(r){
          $btn.btnload("unload");
          System.showError(r);
        }
      });

    });

  };

  t.initAddresses = function(){

    var $panel = System.getPanelApi(t.$el.find("#tab-person-addresses"));

    var tplAddressesAll = t.getTpl("tpl-person-addresses");

    var $tbody = t.$el.find("#tab-person-addresses table tbody");
    var $form = t.$el.find("#form-addresses");

    $panel.load();

    rest({
      url:PATH+"/persons/"+t.getIdperson()+"/addresses",
      success:function(r){

        $tbody.html('');

        $.each(r.data, function(index, row){

          row.descep = t.formatCep(row.descep);

          var $tr = $(tplAddressesAll(row));

          $tbody.append($tr);

          $tr.find(".btn-address-edit").on("click", function(){

            t.setTabActive('tab-address-edit');

            rest({
              url:PATH+"/addresses/"+row.idaddress,
              success:function(r){
                t.renderAddress(r.data);
              },
              failure:function(r){
                System.showError(r);
              }
            });            

          });

          $tr.find(".btn-danger").on("click", function(){

            var $btn = $(this);

            $btn.btnload("load");

            rest({
              url:PATH+"/admin/addresses/"+row.idaddress,
              method:"DELETE",
              success:function(){
                $btn.btnload("unload");
                $tr.remove();
              },
              failure:function(r){
                $btn.btnload("unload");
                System.showError(r);
              }
            });

          });

        });        

        $panel.done();

        $("#tab-person-addresses .btn-group .dropdown-item").on("click", function(){

          var idaddresstype = $(this).data("idaddresstype");

          t.setTabActive('tab-person-address-add');

          var $formAdd = t.$el.find("#address-add form");

          $formAdd.find("[name=idaddresstype]").val(idaddresstype);

          $formAdd.find("[name=idaddresstype]").combobox({
            url:PATH+"/addressestypes",
            displayField:"desaddresstype",
            valueField:"idaddresstype"
          });

          $formAdd.find('[name=descep]').formValueCheck({
            url:PATH+"/addresses/cep",
            success:function(r){
              $formAdd.formLoad(r);
              $formAdd.find("[name=descity]").trigger("change");
              $formAdd.find("[name=desnumber]").trigger("focus");
            }
          });

          $formAdd.find(".btn-success").on("click", function(){

            var $btn = $(this);

            $btn.btnload("load");

            t.saveAddress($formAdd, function(){
              t.initAddresses();
              t.setTabActive('tab-person-addresses');
              $formAdd.find("input").val('');
            });

            $btn.btnload("unload");

          });

        });        

      },
      failure:function(r){
        $panel.done();
        System.showError(r);
      }
    });

  };

  t.initLogs = function(page){

    if(!page) page = 1;

    var data = {
      page:page,
      limit:5
    }

    var $panelHTML = $("#tab-person-log .panel");

    var $panel = System.getPanelApi($panelHTML);

    var tpl = t.getTpl("tpl-person-log");

    var $tbody = $panelHTML.find("tbody");

    $panel.load();

    rest({
      url:PATH+"/persons/"+t.getIdperson()+"/logs",
      data:data,
      success:function(r){

        $tbody.html('');

        $.each(r.data, function(index, row){

          var $tr = $(tpl(row));

          $tbody.append($tr);

        });

        if (r.total > 0) {

          var config = $.extend({}, PluginAspaginator.default.getDefaults(), {
            skin:'pagination-gap',
            currentPage: r.currentPage,
            itemsPerPage: r.itemsPerPage,
            onChange: function(page){
              
              t.initLogs(page);

            }
          }, r);

          $panelHTML.find('#pagination').show().asPaginator(r.total, config);

        } else {

          $panelHTML.find('#pagination').hide();

        }

        $panel.done();

      },
      failure:function(r){
        $panel.done();
        System.showError(r);
      }
    });

  };

  t.initTabs = function(){

    var tabs = new Tab({
      id:"tabs-persons",
      items:[{
        title:"Home",
        id:"tab-person-home"
      },{
        title:"Vendas",
        id:"tab-person-orders"
      },{
        title:"HistÃ³rico",
        id:"tab-person-log"
      },{
        title:"Fale Conosco",
        id:"tab-person-sitecontact"
      },{
        title:"Arquivos",
        id:"tab-person-files"
      },{
        title:"EndereÃ§os",
        id:"tab-person-addresses"
      },{
        title:"Categorias",
        id:"tab-person-categories"
      }],
      listeners:{
        tabchange:function(obejct, event){

          switch (event.tabContent.id) {

            case 'tab-person-orders':
            t.$el.find('[name=idnegotiation]').combobox({
              url:'/ordersnegotiationstypes',
              displayField:'desnegotiation',
              valueField:'idnegotiation'
            });
            t.loadTableSales();
            break;

            case 'tab-person-sitecontact':
            t.loadSiteContact();
            System.initAutoHeight($('#tab-person-sitecontact'));
            break;

            case 'tab-person-files':
            t.loadFiles();
            break;

            case 'tab-person-addresses':
            t.initAddresses();
            break;

            case 'tab-person-categories':
            t.initCategories();
            break;

            case 'tab-person-log':
            t.initLogs();
            break;
            
          }

        }
      }
    });

  };

  function setPagination(id, opts){

    if (opts.total > 0) {

      var config = $.extend({}, PluginAspaginator.default.getDefaults(), {
        skin:'pagination-gap',
        currentPage: opts.currentPage,
        itemsPerPage: opts.itensPerPage,
        onChange: function(page){
          
          t.pagination[id] = page;
          opts.load(page);

        }
      }, opts);

      t.pagination[id] = opts.currentPage;

      $(opts.selector).show().asPaginator(opts.total, config);

    } else {

      $(opts.selector).hide();

    }

  }

  function getPagination(id){

    return parseInt(t.pagination[id]) || 1;

  }

  function loadDefault(url, cache, callback){

    if (typeof cache === 'undefined') cache = true;
    if (typeof page === 'undefined') page = 1;

    $.store({
      cache:cache,
      url:url,
      success:function(data, result){
        if (typeof callback === 'function') callback(data, result);
      },
      failure:function(e){
        System.showError(e);
        if (typeof callback === 'function') callback(false);
      }
    });

  }

  t.loadSiteContact = function(){

    var id = 'person-sitecontact';
    var limit = t.limit;
    var $panel = $('#tab-person-sitecontact > .panel');
    var panel = System.getPanelApi($panel);
    var $list = $('#tab-person-sitecontact .chats');

    if (typeof page === 'undefined') page = getPagination(id) || 1;

    panel.load();

    loadDefault(PATH+"/persons/"+t.getIdperson()+"/site-contact?page="+page+"&limit="+limit, false, function(data, result){

      $list.html('');

      $.each(data, function(index, row){

        var $item = $(t.getTpl('tpl-person-sitecontact-row')(row));

        if (!row.inanswer) $item.addClass('chat-left');

        $list.append($item);

      });

      setPagination(id, $.extend({}, result, {
        selector:"#tab-person-sitecontact .pagination",
        load:t.loadSiteContact
      }));

      panel.done();

      if (typeof callback === 'function') callback(data);

    });

  };

  t.loadFiles = function(page, callback){

    var id = 'person-files';
    var limit = t.limit;

    limit = Math.floor((window.innerHeight-300)/127);
    limit *= Math.floor(t.$el.find('#tab-person-files').find('.blocks').width()/134);
    limit = (limit<5)?5:limit;

    var $panel = $('#tab-person-files > .panel');
    var panel = System.getPanelApi($panel);
    var $list = $('#tab-person-files ul');

    if (typeof page === 'undefined') page = getPagination(id) || 1;

    panel.load();

    loadDefault(PATH+"/persons/"+t.getIdperson()+"/files?page="+page+"&limit="+limit, false, function(data, result){

      $list.html('');

      $.each(data, function(index, row){

        var $item = $(t.getTpl('tpl-person-file')(row));

        $list.append($item);

        $item.find(".selectable-item").on("change", function(){

          var selected = $("#tab-person-files [type=checkbox]:checked");

          var disabled = (selected.length > 0) ? false : true;

          $("#btn-person-files-remove").prop("disabled", disabled);

        });

      });

      $("#btn-person-files-remove").on("click", function(){

        var $btn = $(this);

        $btn.btnload("load");

        var ids = [];

        $("#tab-person-files [type=checkbox]:checked").each(function(){
          ids.push($(this).data("idfile"));
        });

        rest({
          url:PATH+"/files",
          method:"DELETE",
          data:{
            ids:ids.toString()
          },
          success:function(){
            $btn.btnload("unload");
            t.loadFiles(1);
          },
          failure:function(r){
            $btn.btnload("unload");
            System.showError(r);
          }
        });

      });

      setPagination(id, $.extend({}, result, {
        selector:"#tab-person-files .pagination",
        load:t.loadFiles
      }));

      panel.done();

      if (typeof callback === 'function') callback(data);

    });

  };

  t.loadTableSales = function(page, callback){

    var id = 'person-sales';
    var limit = t.limit;
    var $panel = $('#tab-person-orders > .panel');
    var panel = System.getPanelApi($panel);
    var $tbody = $('#tab-person-orders tbody');

    if (typeof page === 'undefined') page = getPagination(id) || 1;

    panel.load();

    loadDefault(PATH+"/persons/"+t.getIdperson()+"/orders?page="+page+"&limit="+limit, false, function(data, result){

      $tbody.html('');

      $.each(data, function(index, row){

        var $tr = t.getTpl('tpl-person-order-row')(row);

        $tbody.append($tr);

      });

      setPagination(id, $.extend({}, result, {
        selector:"#tab-person-files .pagination",
        load:t.loadFiles
      }));

      panel.done();

      if (typeof callback === 'function') callback(data);

    });

  };

  t.initCategories = function(){

    var $panelHTML = $("#tab-person-categories .panel");

    var $panel = System.getPanelApi($panelHTML);

    $panel.load();

    var $ul = $panelHTML.find("ul");

    var tpl = t.getTpl("tpl-person-category");

    rest({
      url:PATH+"/persons-categories/all",
      success:function(r){

        $ul.html('');

        $.each(r.data, function(index, row){

          var $li = $(tpl(row));

          $ul.append($li);

          $.each(t.getData().Categories, function(indice, value){

            if(row.idcategory == value.idcategory){
              $li.find("[type=checkbox]").prop("checked", true);
            }

          });

          $li.find("[type=checkbox]").on("change", function(){

            var $input = $(this);

            $input.btnload("load");

            var ids = [];

            $panelHTML.find("ul.list-group li [type=checkbox]:checked").each(function(){
              ids.push($(this).data("idcategory"));
            });

            rest({
              url:PATH+"/persons/"+t.getIdperson()+"/categories",
              method:"POST",
              data:{
                ids:ids.toString()
              },
              success:function(){
                $input.btnload("unload");
              },
              failure:function(r){
                $input.btnload("unload");
                System.showError(r);
              }
            })

          });

        });

        $panel.done();

      },
      failure:function(r){
        $panel.done();
        System.showError(r);
      }
    })

  };

  t.init = function(){

    t.initFieldClassEmpty();
    t.initFieldCPF();
    t.initFieldPersonType();
    t.initFormPersonEdit();
    t.initTabs();

    t.$el.on('click', '#btn-actions-refresh', function(){

      var $btn = $(this);

      $btn.btnload('load');

      t.reload(function(){

        $btn.btnload('unload');

      });

    });

    t.$el.on('click', '#btn-order-reload', function(){

      var $btn = $(this);

      $btn.btnload('load');

      t.loadTableSales(1, function(){

        $btn.btnload('unload');

      });
      
    });

    t.$el.on('click', '#btn-actions-close', function(){

      t.setTabActive('tab-person-home');
      
    });

    t.$el.on('click',  "#btn-actions-address-close", function(){

      t.setTabActive('tab-person-addresses');

    });

    t.$el.on('click', "#btn-actions-address-add-close", function(){

      t.setTabActive('tab-person-addresses');

    });

    t.$el.on('click', '#btn-person-edit', function(){

      t.setTabActive('tab-person-edit');

    });

    t.$el.on('click', '#btn-delete-person', function(){

      t.deletePerson();

    });

    t.$el.on('click', '#person-photo', function(){

      t.uploadPhoto();

    });

    t.$el.on('click', '#btn-person-files-reload', function(){

      var $btn = $(this);

      $btn.btnload('load');

      t.loadFiles(1, function(){

        $btn.btnload('unload');

      });

    });

    t.$el.on('click', '#btn-person-files-upload', function(){

      $.upload({
        url:PATH+"/persons/"+t.getIdperson()+"/files",
        multiple:true,
        accept:"*",
        modalInfo:true,
        success:function(data){

          t.loadFiles(1);

        }
      });

    });

  };

  t.init();

});

var person = JSON.parse('{function="json_encode($person)"}');  
var personPanel = new personPanel(person, '#person-panel');
</script>