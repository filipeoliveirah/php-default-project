<style>.slidePanel{
		overflow: overlay;
	}</style><div id="lugar-panel"><header class="slidePanel-header"><div class="overlay-top overlay-panel overlay-background bg-indigo-600"><div class="slidePanel-actions btn-group btn-group-flat" aria-label="actions" role="group"><button id="btn-delete-lugar" type="button" class="btn btn-pure icon md-delete waves-effect" aria-hidden="true"></button> <button type="button" class="btn btn-pure slidePanel-close icon md-close" aria-hidden="true"></button></div><h4 class="stage-name"><h5 class="taskboard-stage-title text-uppercase">Dados de {$lugar.deslugar}</h5></h4></div></header><div class="slidePanel-inner m-0 p-0"><div class="panel nav-tabs-horizontal nav-tabs-inverse" id="lugar-tabs" data-plugin="tabs"><div class="panel-heading panel-heading-tab" id="tabs-lugar" style="border-radius: 0"></div><div class="panel-body p-t-20"><div class="tab-content"><div class="tab-pane" id="tab-lugar-editar" role="tabpanel"><form id="form-lugar-editar"><div class="panel m-0" style="box-shadow:none"><div class="panel-body p-y-0 p-t-20"><div class="panel-heading" style="height: 30px"><div class="panel-actions panel-actions-keep"><a id="btn-actions-refresh" class="panel-action icon md-refresh-alt" aria-hidden="true" style="font-size:16px"></a> <a id="btn-actions-close" class="panel-action icon md-close" aria-hidden="true" style="font-size:16px"></a></div></div><div class="row"><div class="form-group col-xs-12 col-md-8" data-plugin="formMaterial"><label class="form-control-label">Lugar</label><input type="text" class="form-control" name="deslugar"></div><div class="form-group col-xs-12 col-md-4" data-plugin="formMaterial"><label class="form-control-label">Tipo do Lugar</label><select name="idlugartipo" class="form-control"></select></div></div><div class="panel panel-primary panel-line p-b-0 m-0 m-t-20"><div class="panel-heading"><h3 class="panel-title p-l-0">Endereço</h3></div><div class="row"><div class="form-group col-xs-12 col-md-6"><label class="form-control-label" for="descep">CEP</label><input type="text" class="form-control" id="descep" name="descep"></div><div class="form-group col-xs-12 col-md-6"><label class="form-control-label" for="idenderecotipo">Tipo do Endereço</label><select name="idenderecotipo" class="form-control"></select></div></div><div class="row"><div class="form-group col-xs-12 col-md-6"><label class="form-control-label" for="desendereco">Endereço</label><input type="text" class="form-control" id="desendereco" name="desendereco"></div><div class="form-group col-xs-12 col-md-3"><label class="form-control-label" for="desnumero">Número</label><input type="text" class="form-control" id="desnumero" name="desnumero"></div><div class="form-group col-xs-12 col-md-3"><label class="form-control-label" for="descomplemento">Complemento</label><input type="text" class="form-control" id="descomplemento" name="descomplemento"></div></div><div class="row"><div class="form-group col-xs-12 col-md-6"><label class="form-control-label" for="desbairro">Bairro</label><input type="text" class="form-control" id="desbairro" name="desbairro"></div><div class="form-group col-xs-12 col-md-6"><label class="form-control-label" for="descidade">Cidade</label><input type="text" class="form-control" id="descidade" name="descidade"> <input type="hidden" name="desuf"></div></div></div><div class="form-group form-material" data-plugin="formMaterial"><button type="submit" class="btn btn-primary waves-effect">Salvar</button></div></div></div></form></div><div class="tab-pane active" id="tab-lugar" role="tabpanel"><button id="btn-lugar-editar" class="btn btn-primary pull-xs-right waves-effect"><i class="icon md-edit" aria-hidden="true"></i> editar</button><div class="card"></div></div><div class="tab-pane" id="tab-lugar-mapa" role="tabpanel"><input type="hidden" name="vllatitude"> <input type="hidden" name="vllongitude"> <input type="hidden" name="nrzoom"><div id="mapa" style="width:100%;height:400px"></div><div class="form-group form-material m-t-15" data-plugin="formMaterial"><button type="button" class="btn btn-primary waves-effect btn-salvar">Salvar</button></div></div><div class="tab-pane panel" id="tab-lugar-horarios" role="tabpanel"><table class="table table-stripped table-hover"><thead><tr><th><input type="checkbox" id="horariosTodos"><th>Dia<th>Horário de Abertura<th>Horário de Fechamento<th><tbody></table><div class="form-group form-material m-t-15" data-plugin="formMaterial"><button type="button" class="btn btn-primary waves-effect btn-salvar-horarios">Salvar</button></div></div></div></div></div></div></div>{noparse}<script id="tpl-lugar-home-card" type="text/x-handlebars-template"><div class="card-header bg-white p-30 clearfix">
  <div class="pull-xs-left">
    <div class="font-size-20 m-b-15">{{deslugar}}</div>
    {{#if desendereco}}
    <p class="m-b-5 text-nowrap"><i class="icon md-pin m-r-10" aria-hidden="true"></i>
      <span class="text-break">{{desendereco}}</span>
    </p>
    {{/if}}
  </div>
</div></script>{/noparse}<script id="tpl-lugar-horario" type="text/x-handlebars-template"><tr data-nrdia="{{nrweekday}}">
		<td><input type="checkbox"></td>
		<td>{{desweekday}}</td>
		<td><input type="time" name="hrabre" class="form-control" value="{{hrabre}}" disabled="disabled"></td>
		<td><input type="time" name="hrfecha" class="form-control" value="{{hrfecha}}" disabled="disabled"></td>
		<td><button type="button" class="btn btn-default" disabled="disabled">Padrão</button></td>
	</tr></script><script>var LugarPanel = (function(data, selectorContainer, opts){

  var t = this;

  var defaults = {
    debug:false
  };

  var o = $.extend({}, defaults, opts);

  t.$el = $(selectorContainer);
  t.id = 0;

  t.setData = function(lugar){

    t.data = lugar;
    t.$el.trigger('lugar-change');

  };

  t.getData = function(){

    return t.data;

  };

  t.getTpl = function(id){

    return Handlebars.compile($("#"+id).html());

  };

  t.setCard = function(){

    var tpl = t.getTpl('tpl-lugar-home-card');
    var $render = $(tpl(t.getData()));

    t.$el.find('#tab-lugar').find('.card').html($render);

  };

  t.formatCep = function(cep){

  	return cep.substring(0, 5)+"-"+cep.substring(5);

  }

  t.$el.on('lugar-change', function(){

    var lugar = t.getData();

    lugar.descep = t.formatCep(lugar.descep);

    t.$el.find('#form-lugar-editar').formLoad(lugar);
    t.setCard(t.getData());

  });
  
  t.setData(lugar);

  t.getIdlugar = function(){

    return t.getData().idlugar;

  };

  t.deleteLugar = function(){

    System.confirm("Deseja realmente excluir o cadastro de "+data.deslugar+"?", function(r, s, f){

      if (r) {

        rest({
          url:PATH+"/lugares/"+t.getIdlugar(),
          method:"DELETE",
          success:function(){
            s();
            data = {};
            $(".slidePanel-close").trigger("click");
            $("#form-filtros [type=submit]").trigger("click");
          },
          failure:function(e){
            System.showError(e);
            f(e.error);
          }
        });

      } else {

        f();

      }

    });

  };

  t.setTabActive = function(id){

    $('#lugar-tabs .tab-content .tab-pane').removeClass('active');
    $('#lugar-tabs .tab-content .tab-pane#'+id).addClass('active');
    $('#lugar-tabs [role="tab"]').removeClass('active');
    $('#lugar-tabs [role="tab"][href="#'+id+'"]').addClass('active');

  };

  t.initFieldCidade = function(){

    t.$el.find('[name=descidade]').combobox({
      url:PATH+"/enderecos/cidades",
      autoComplete:true,
      displayField:'descidade',
      displayFieldRight:'desuf',
      valueField:'idcidade',
      submitValue:true,
      hiddenName:'idcidade'
    });

  };

  t.initFieldClassEmpty = function(){

    t.$el.find('input').on('change', function(){
      if ($(this).val().length) {
        $(this).removeClass('empty');
      } else {
        $(this).addClass('empty');
      }
    });

  };

  t.initFieldCEP = function(){

    t.$el.find('[name=descep]').formValueCheck({
      url:PATH+"/enderecos/cep",
      success:function(r){
        t.$el.find('#form-lugar-editar').formLoad(r);
        t.$el.find('#form-lugar-editar').find('[name=descidade]').trigger('change');
        t.$el.find('#form-lugar-editar').find('[name=desnumero]').trigger('focus');
      }
    });

  };

  t.initFieldsTipos = function(){

    t.$el.find("[name=idlugartipo]").combobox({
      url:PATH+"/lugares-tipos",
      displayField:"deslugartipo",
      valueField:"idlugartipo",
      value:t.getData().idlugartipo
    });

    t.$el.find("[name=idenderecotipo]").combobox({
      url:PATH+"/enderecostipos",
      displayField:"desenderecotipo",
      valueField:"idenderecotipo",
      value:t.getData().idenderecotipo
    });

  };

  t.initFormLugarEditar = function(){

    t.$el.find('#form-lugar-editar').form({
      url:PATH+"/lugares",
      params:{
      	idlugar:t.getData().idlugar,
      	idendereco:t.getData().idendereco
      },
      resetForm:false,
      success:function(r){

        t.setData(r.data);
        System.success('Dados salvos com sucesso!');
        t.refreshList();

      }
    });

  };

  t.reload = function(callback){

    rest({
      url:PATH+"/lugares/"+t.getIdlugar(),
      success:function(r){

        t.setData(r.data);
        if (typeof callback === 'function') callback();

      },
      failure:function(e){

        System.showError(e);

      }
    });

  };

  t.refreshList = function(){

  	$("#form-filtros [type=submit]").trigger("click");

  };

  t.initMap = function(){

  	var position = {
		lat: -8.361126490598373,
		lng: -55.705590349999966
	}

	var zoom = 3;

	if(parseFloat(t.getData().vllatitude) != 0 && parseFloat(t.getData().vllongitude) != 0){
		position.lat = t.getData().vllatitude;
		position.lng = t.getData().vllongitude;
		zoom = t.getData().nrzoom;
	}

	var map = new google.maps.Map(document.getElementById("mapa"), {
		center:{lat: position.lat, lng: position.lng},
		zoom:zoom
	});

	var marker = new google.maps.Marker({
		position:position,
		map:map,
		draggable:true
	});

	marker.setMap(map);

	t.$el.find("#tab-lugar-mapa [name=vllatitude]").val(position.lat);
	t.$el.find("#tab-lugar-mapa [name=vllongitude]").val(position.lng);
	t.$el.find("#tab-lugar-mapa [name=nrzoom]").val(zoom);

	google.maps.event.addListener(marker, 'dragend', function(){

		t.$el.find("#tab-lugar-mapa [name=vllatitude]").val(marker.getPosition().lat());
		t.$el.find("#tab-lugar-mapa [name=vllongitude]").val(marker.getPosition().lng());
		t.$el.find("#tab-lugar-mapa [name=nrzoom]").val(map.getZoom());

	});

  };

  var isHorariosLogged = 0;

  t.initHorarios = function(){

  	if(isHorariosLogged == 0){

		var $panel = System.getPanelApi(t.$el.find("#tab-lugar-horarios"));

		var $tbody = t.$el.find("#tab-lugar-horarios").find("table tbody");

		$panel.load();

		$tbody.html('');

		var tplHorarios = t.getTpl("tpl-lugar-horario");

		$.each(t.getData().Horarios, function(index, row){

			var $tr = $(tplHorarios(row))

			$tbody.append($tr);

			$tr.find("input[type=checkbox]").on("change", function(){

				var disabled = !$(this).prop('checked');

				$tr.find('input:not(:checkbox)').attr('disabled', disabled);
	        	$tr.find('button').attr('disabled', disabled);

	        	if(disabled){
	        		$tr.find("input:not(:checkbox)").val("");
	        	}

			});

			$tr.find(".btn-default").on("click", function(){

				var hrabre = $tr.find("[name=hrabre]").val();
				var hrfecha = $tr.find("[name=hrfecha]").val();

				t.$el.find("#tab-lugar-horarios tbody tr [name=hrabre]:enabled").val(hrabre);
				t.$el.find("#tab-lugar-horarios tbody tr [name=hrfecha]:enabled").val(hrfecha);

			});

		});

		$panel.done();

		t.$el.find('#horariosTodos').on('change', function() {

	        t.$el.find('#tab-lugar-horarios tbody :checkbox').prop('checked', $(this).prop('checked')).trigger('change');

	    });

		t.$el.find("#tab-lugar-horarios .btn-salvar-horarios").on("click", function(){

			var $btn = $(this);

			$btn.btnload("load");

			var nrdia = [];
			var hrabre = [];
			var hrfecha = [];

			t.$el.find("#tab-lugar-horarios tbody tr").each(function(){

				if($(this).find(":checkbox").prop("checked") || $(this).find("[type='time']").val() != '00:00:00'){

					nrdia.push($(this).data("nrdia"));
					hrabre.push($(this).find("[name=hrabre]").val());
					hrfecha.push($(this).find("[name=hrfecha]").val());

				}

			});

			rest({
				url:PATH+"/lugares-horarios",
				method:"POST",
				data:{
					ids:lugar.idlugar.toString(),
					nrdia:nrdia.toString(),
					hrabre:hrabre.toString(),
					hrfecha:hrfecha.toString()
				},
				success:function(){
					$btn.btnload("unload");
					isHorariosLogged = 1;
				},
				failure:function(r){				
					System.showError(r);
					$btn.btnload("unload");
				}
			});

		});

	}

  };

  t.initTabs = function(){

	var tabs = new Tab({
		id:"tabs-lugar",
		items:[{
			title:"Dados",
			id:"tab-lugar"
		},{
			title:"Mapa",
			id:"tab-lugar-mapa"
		},{
			title:"Horários",
			id:"tab-lugar-horarios"
		}],
		listeners:{
			tabchange:function(object, event){

				switch(event.tabContent.id){

					case "tab-lugar-horarios":
					t.initHorarios();

					break;

					case "tab-lugar-mapa":
					t.initMap();

					break;

				}

			}
		}
	})

  };

  t.init = function(){

    t.initFieldCidade();
    t.initFieldClassEmpty();
    t.initFieldCEP();
    t.initFieldsTipos();
    t.initFormLugarEditar();    
    t.initTabs();

    t.$el.find("[name=descidade]").trigger("change");

    t.$el.on('click', '#btn-actions-refresh', function(){

      var $btn = $(this);

      $btn.btnload('load');

      t.reload(function(){

        $btn.btnload('unload');

      });

    });

    t.$el.on('click', '#btn-actions-close', function(){

      t.setTabActive('tab-lugar');
      
    });

    t.$el.on('click', '#btn-lugar-editar', function(){

      t.setTabActive('tab-lugar-editar');

    });

    t.$el.on('click', '#btn-delete-lugar', function(){

      t.deleteLugar();

    });

    t.$el.on('click', '#lugar-photo', function(){

      t.uploadPhoto();

    });

    t.$el.on("click", "#tab-lugar-mapa .btn-salvar", function(){

		var $btn = $(this);

		$btn.btnload("load");

		rest({
			url:PATH+"/lugares/"+lugar.idlugar+"/coordenadas",
			method:"POST",
			data:{
				idcoordenada:lugar.idcoordenada,
				vllatitude:t.$el.find("#tab-lugar-mapa [name=vllatitude]").val(),
				vllongitude:t.$el.find("#tab-lugar-mapa [name=vllongitude]").val(),
				nrzoom:t.$el.find("#tab-lugar-mapa [name=nrzoom]").val()
			},
			success:function(){
				$btn.btnload("unload");
			},
			failure:function(r){
				$btn.btnload("unload");
				System.showError(r);
			}
		})

	});

  };

  t.init();

});

var lugar = JSON.parse('{function="json_encode($lugar)"}');
var lugarPanel = new LugarPanel(lugar, '#lugar-panel');</script><script async defer="defer" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZeruuGhybNkWSI8VK7tYiynxt3epFPEg&callback=initMap"></script>