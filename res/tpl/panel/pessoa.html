<link rel="stylesheet" href="{$path}/res/css/slide-panel.css"><header class="slidePanel-header"><div class="overlay-top overlay-panel overlay-background bg-indigo-600"><div class="slidePanel-actions btn-group btn-group-flat" aria-label="actions" role="group"><button type="button" class="btn btn-pure slidePanel-close icon md-close" aria-hidden="true"></button></div><h4 class="stage-name"><h5 class="taskboard-stage-title text-uppercase">Dados de {$pessoa.despessoa}</h5></h4></div></header><div class="slidePanel-inner p-0"><section class="slidePanel-inner-section p-0 m-t-40"><div class="card card-inverse m-b-0"></div><div class="panel nav-tabs-horizontal" data-plugin="tabs"><div class="panel-heading p-30 p-b-0 p-t-10"><ul class="nav nav-pills" role="tablist"><li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#pessoaTab" aria-controls="pessoaTab" role="tab" aria-expanded="true">Pessoa</a><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#siteContatosTab" aria-controls="siteContatosTab" role="tab" aria-expanded="false">Fale conosco</a><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#cartoesTab" aria-controls="cartoesTab" role="tab" aria-expanded="false">Cartões de Crédito</a><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#carrinhosTab" aria-controls="carrinhosTab" role="tab" aria-expanded="false">Carrinhos</a></ul></div><div class="panel-body p-t-20"><div class="tab-content"><div class="tab-pane active" id="pessoaTab" role="tabpanel" aria-expanded="true"><form id="pessoa-form"><div class="form-group form-material" data-plugin="formMaterial"><label class="form-control-label" for="despessoa">Nome</label><input type="text" class="form-control" id="despessoa" name="despessoa" value="{$pessoa.despessoa}"></div><div class="form-group form-material" data-plugin="formMaterial"><label class="form-control-label" for="idpessoatipo">Tipo da Pessoa</label><select class="form-control" name="idpessoatipo" id="idpessoatipo" value="{$pessoa.idpessoatipo}"></select></div><label class="form-control-label"><h4>Telefones</h4></label><div id="panel-telefones"></div><label class="form-control-label"><h5>Adicionar novo telefone</h5></label><div class="row telefone-add"><div class="form-group form-material col-md-6" data-plugin="formMaterial"><div class="input-group p-b-20"><div class="form-control-wrap"><select name="idcontatosubtipo" class="form-control"></select></div></div></div><div class="form-group form-material col-md-6"><div class="input-group p-b-20"><div class="form-control-wrap"><input type="text" class="form-control" placeholder="Telefone"></div><span class="input-group-btn"><button type="button" class="btn btn-success btn-outline input-search-close icon wb-plus-circle" style="padding:10px"></button></span></div></div></div><label class="form-control-label"><h4>Emails</h4></label><div class="panel" id="panel-emails"></div><label class="form-control-label"><h5>Adicionar novo email</h5></label><div class="row email-add"><div class="form-group form-material col-md-6" data-plugin="formMaterial"><div class="input-group p-b-20"><div class="form-control-wrap"><select name="idcontatosubtipo" class="form-control"></select></div></div></div><div class="form-group form-material col-md-6"><div class="input-group p-b-20"><div class="form-control-wrap"><input type="text" class="form-control" placeholder="Email"></div><span class="input-group-btn"><button type="button" class="btn btn-success btn-outline input-search-close icon wb-plus-circle" style="padding:10px"></button></span></div></div></div><label class="form-control-label"><h4>Documentos</h4></label><div class="panel" id="panel-documentos"></div><label class="form-control-label"><h5>Adicionar novo documento</h5></label><div class="row documento-add"><div class="form-group form-material col-md-6" data-plugin="formMaterial"><div class="input-group p-b-20"><div class="form-control-wrap"><select name="iddocumentotipo" class="form-control"></select></div></div></div><div class="form-group form-material col-md-6"><div class="input-group p-b-20"><div class="form-control-wrap"><input type="text" class="form-control" placeholder="Documento"></div><span class="input-group-btn"><button type="button" class="btn btn-success btn-outline input-search-close icon wb-plus-circle" style="padding:10px"></button></span></div></div></div><div class="form-group form-material"><button type="submit" class="btn btn-primary waves-effect btn-salvar-pessoa">Salvar</button></div></form></div><div class="tab-pane panel panel-site-contatos" id="siteContatosTab" role="tabpanel" aria-expanded="false"><div class="panel-actions"><a class="panel-action icon md-refresh-alt refresh" data-toggle="panel-refresh" data-load-type="round-circle" aria-hidden="true"></a></div><table class="table-site-contatos table table-hover table-striped"><thead><tr><th>Mensagem<th>Data<tbody></table></div><div class="tab-pane panel panel-cartoes" id="cartoesTab" role="tabpanel" aria-expanded="false"><div class="panel-actions"><a class="panel-action icon md-refresh-alt refresh" data-toggle="panel-refresh" data-load-type="round-circle" aria-hidden="true"></a></div><table class="table-contatos table table-hover table-striped"><thead><tr><th>Nome do titular<th>Data de Validade<th>Número<tbody></table></div><div class="tab-pane panel panel-carrinhos" id="carrinhosTab" role="tabpanel" aria-expanded="false"><div class="panel-actions"><a class="panel-action icon md-refresh-alt refresh" data-toggle="panel-refresh" data-load-type="round-circle" aria-hidden="true"></a></div><table class="table-contatos table table-hover table-striped"><thead><tr><th>Número de Produtos<th>Valor Total<tbody></table></div></div></div></div></section></div><script id="tpl-telefone-pessoa" type="text/x-handlebars-template"><div class="row">    
    <div class="form-group form-material col-md-5" data-plugin="formMaterial">
      <select class="form-control" name="idcontatosubtipo" value="{{idcontatosubtipo}}"></select>
    </div>
    <div class="form-group form-material col-md-5" data-plugin="formMaterial">
      <input type="text" class="form-control" id="descontato" name="descontato" placeholder="Adicionar novo telefone" value="{{descontato}}">
    </div>
    <div class="form-group form-material col-md-2" data-plugin="formMaterial">
      <span class="input-group-btn">
        <button type="button" class="btn btn-info btn-outline input-search-close icon wb-check" style="padding:10px"></button>
        <button type="button" class="btn btn-danger btn-outline input-search-close icon wb-close" style="padding:10px"></button>
      </span>
    </div>
  </div></script><script id="tpl-email-pessoa" type="text/x-handlebars-template"><div class="row">
    <div class="form-group form-material col-md-5" data-plugin="formMaterial">
      <select class="form-control" name="idcontatosubtipo" value="{{idcontatosubtipo}}"></select>
    </div>
    <div class="form-group form-material col-md-5" data-plugin="formMaterial">
      <input type="text" class="form-control" id="descontato" name="descontato" value="{{descontato}}" placeholder="Adicionar novo email">
    </div>
    <div class="form-group form-material col-md-2" data-plugin="formMaterial">
      <span class="input-group-btn">
        <button type="button" class="btn btn-info btn-outline input-search-close icon wb-check" style="padding:10px"></button>
        <button type="button" class="btn btn-danger btn-outline input-search-close icon wb-close" style="padding:10px"></button>
      </span>
    </div>
  </div></script><script id="tpl-documento-pessoa" type="text/x-handlebars-template"><div class="row">
    <div class="form-group form-material col-md-5" data-plugin="formMaterial">
      <select class="form-control" name="iddocumentotipo" value="{{iddocumentotipo}}"></select>
    </div>
    <div class="form-group form-material col-md-5" data-plugin="formMaterial">
      <input type="text" class="form-control" id="desdocumento" name="desdocumento" value="{{desdocumento}}" placeholder="Adicionar novo documento">
    </div>
    <div class="form-group form-material col-md-2" data-plugin="formMaterial">
      <span class="input-group-btn">
        <button type="button" class="btn btn-info btn-outline input-search-close icon wb-check" style="padding:10px"></button>
        <button type="button" class="btn btn-danger btn-outline input-search-close icon wb-close" style="padding:10px"></button>
      </span>
    </div>
  </div></script><script id="tpl-cartao-pessoa" type="text/x-handlebars-template"><tr data-idcartao="{{idcartao}}">
    <td>{{desnome}}</td>
    <td>{{dtvalidade}}</td>
    <td>{{desnumero}}</td>
  </tr></script><script id="tpl-site-contato-pessoa" type="text/x-handlebars-template"><tr data-idsitecontato="{{idsitecontato}}">
    <td>{{desmensagem}}</td>
    <td>{{desdtcadastro}}</td>
  </tr></script><script id="tpl-carrinho-pessoa" type="text/x-handlebars-template"><tr data-idcarrinho="{{idcarrinho}}">
    <td>{{nrprodutos}}</td>
    <td>{{vltotal}}</td>
  </tr></script><script>(function(){

    var pessoa = JSON.parse('{function="json_encode($pessoa)"}');

    console.log(pessoa);

    var tplTelefones = Handlebars.compile($("#tpl-telefone-pessoa").html());
    var tplEmails = Handlebars.compile($("#tpl-email-pessoa").html());    
    var tplDocumentos = Handlebars.compile($("#tpl-documento-pessoa").html());

    $panelTelefones = $("#panel-telefones");
    $panelEmails = $("#panel-emails");    
    $panelDocumentos = $("#panel-documentos");

    function renderTelefones(telefones){

      $panelTelefones.html('');

      $.each(telefones, function(index, row){

        var $input = $(tplTelefones(row));

        $panelTelefones.append($input);

        $input.find("[name=idcontatosubtipo]").combobox({
          url:PATH+"/contatossubtipos?idcontatotipo=2",
          displayField:"descontatosubtipo",
          valueField:"idcontatosubtipo",
          value:row.idcontatosubtipo
        }).on("change", function(){

          var $select = $(this);

          $select.prop("disabled", true);

          rest({
            url:PATH+"/contatos",
            method:"POST",
            data:{
              idcontato:row.idcontato,
              idcontatotipo:row.idcontatotipo,
              idcontatosubtipo:$input.find("[name=idcontatosubtipo]").val(),
              idpessoa:pessoa.idpessoa,
              inprincipal:Number(row.inprincipal),
              descontato:$input.find("input").val()
            },
            success:function(r){
              $select.prop("disabled", false);
            },
            failure:function(r){
              $select.prop("disabled", false);
              System.showError(r);
            }
          });

        });

        $input.find(".btn-info").on("click", function(){

          var $btn = $(this);

          $btn.btnload("load");

          rest({
            url:PATH+"/contatos",
            method:"POST",
            data:{
              idcontato:row.idcontato,
              idcontatotipo:row.idcontatotipo,
              idcontatosubtipo:$input.find("[name=idcontatosubtipo]").val(),
              idpessoa:pessoa.idpessoa,
              inprincipal:Number(row.inprincipal),
              descontato:$input.find("input").val()
            },
            success:function(r){
              $btn.btnload("unload");              
            },
            failure:function(r){
              $btn.btnload("unload");
              System.showError(r);
            }
          });

        });

        $input.find(".btn-danger").on("click", function(){

          System.confirm("Deseja remover o telefone "+row.descontato+"?", function(b, s, f){

            if(b){

              rest({
                url:PATH+"/contatos/"+row.idcontato,
                method:"DELETE",
                success:function(){

                  var tels = [];

                  $.each(pessoa.Telefones, function(index, telefone){
                    if(telefone.idcontato != row.idcontato){
                      tels.push(telefone);
                    }
                  });

                  pessoa.Telefones = tels;

                  $input.remove();

                  System.done();

                },
                failure:function(r){
                  System.done();
                  System.showError(r);
                }
              });

            }else{
              f();
            }

          });

        });

      });      

    }

    renderTelefones(pessoa.Telefones);

    function renderEmails(emails){

      $panelEmails.html('');

      $.each(emails, function(index, row){

        var $tpl = $(tplEmails(row));

        $panelEmails.append($tpl);

        $tpl.find("[name=idcontatosubtipo]").combobox({
          url:PATH+"/contatossubtipos?idcontatotipo=1",
          displayField:"descontatosubtipo",
          valueField:"idcontatosubtipo",
          value:row.idcontatosubtipo
        }).on("change", function(){

          var $select = $(this);

          $select.prop("disabled", true);

          rest({
            url:PATH+"/contatos",
            method:"POST",
            data:{
              idpessoa:pessoa.idpessoa,
              idcontato:row.idcontato,
              idcontatotipo:row.idcontatotipo,
              idcontatosubtipo:$select.val(),
              inprincipal:row.inprincipal,
              descontato:$tpl.find("input").val()
            },
            success:function(){
              $select.prop("disabled", false);
            },
            failure:function(r){
              $select.prop("disabled", false);
              System.showError(r);
            }
          });

        });

        $tpl.find(".btn-info").on("click", function(){

          $btn = $(this);

          $btn.btnload("load");

          rest({
            url:PATH+"/contatos",
            method:"POST",
            data:{
              idpessoa:pessoa.idpessoa,
              idcontato:row.idcontato,
              idcontatotipo:row.idcontatotipo,
              idcontatosubtipo:$tpl.find("[name=idcontatosubtipo]").val(),
              descontato:$tpl.find("input").val(),
              inprincipal:Number(row.inprincipal)
            },
            success:function(){
              $btn.btnload("unload");
            },
            failure:function(r){
              $btn.btnload("unload");
              System.showError(r);
            }
          });

        });

        $tpl.find(".btn-danger").on("click", function(){

          System.confirm("Deseja remover o email "+row.descontato+"?", function(b, s, f){

            if(b){

              rest({
                url:PATH+"/contatos/"+row.idcontato,
                method:"DELETE",
                success:function(){

                  var emails = [];

                  $.each(pessoa.Emails, function(index,email){
                    if(email.idcontato != row.idcontato){
                      emails.push(email);
                    }
                  });

                  pessoa.Emails = emails;

                  $tpl.remove();

                  System.done();

                },
                failure:function(r){
                  System.done();
                  System.showError(r);
                }
              });

            }else{
              f();
            }

          });

        });

      });      

    }

    renderEmails(pessoa.Emails);

    function renderDocumentos(documentos){

      $panelDocumentos.html('');

      $.each(documentos, function(index, row){

        var $input = $(tplDocumentos(row));

        $panelDocumentos.append($input);

        $input.find("[name=iddocumentotipo]").combobox({
          url:PATH+"/documentos/tipos",
          displayField:"desdocumentotipo",
          valueField:"iddocumentotipo",
          value:row.iddocumentotipo
        }).on("change", function(){

          $select = $(this);

          $select.prop("disabled", true);

          rest({
            url:PATH+"/documentos",
            method:"POST",
            data:{
              idpessoa:pessoa.idpessoa,
              iddocumento:row.iddocumento,
              iddocumentotipo:$select.val(),
              desdocumento:$input.find("input").val()
            },
            success:function(){
              $select.prop("disabled", false);
            },
            failure:function(r){
              $select.prop("disabled", false);
              System.showError(r);
            }
          });

        });

        $input.find(".btn-info").on("click", function(){

          var $btn = $(this);

          $btn.btnload("load");

          rest({
            url:PATH+"/documentos",
            method:"POST",
            data:{
              idpessoa:pessoa.idpessoa,
              iddocumento:row.iddocumento,
              iddocumentotipo:$input.find("[name=iddocumentotipo]").val(),
              desdocumento:$input.find("input").val()
            },
            success:function(r){
              $btn.btnload("unload");
            },
            failure:function(r){
              $btn.btnload("unload");
              System.showError(r);
            }
          });

        });

        $input.find(".btn-danger").on("click", function(){

          System.confirm("Deseja remover o "+row.desdocumentotipo+" "+row.desdocumento+"?", function(b, s, f){

            if(b){

              rest({
                url:PATH+"/documentos/"+row.iddocumento,
                method:"DELETE",
                success:function(){

                  var documentos = [];

                  $.each(pessoa.Documentos, function(index, documento){
                    if(documento.iddocumento != row.iddocumento){
                      documentos.push(documento);
                    }
                  });

                  pessoa.Documentos = documentos;

                  $input.remove();

                  s();

                  System.done();

                },
                failure:function(r){
                  System.done();
                  System.showError(r);
                }
              });

            }else{
              f();
            }

          });

        });

      });

    }

    renderDocumentos(pessoa.Documentos);

    // adicionar telefone
    $(".telefone-add [name=idcontatosubtipo]").combobox({
      url:PATH+"/contatossubtipos?idcontatotipo=2",
      displayField:"descontatosubtipo",
      valueField:"idcontatosubtipo",
      emptyText:"Selecione o tipo do telefone"
    });

    $(".telefone-add button").on("click", function(){

      var $form = $(".telefone-add");

      var $btn = $(this);

      $btn.btnload("load");

      rest({
        url:PATH+"/contatos",
        method:"POST",
        data:{
          idcontato:0,
          idpessoa:pessoa.idpessoa,
          idcontatotipo:2,
          idcontatosubtipo:$form.find("[name=idcontatosubtipo]").val(),
          descontato:$form.find("input[type='text']").val(),
          inprincipal:0
        },
        success:function(r){
          $form.find("input, select").val('');
          $btn.btnload("unload");
          pessoa.Telefones.push(r.data);
          renderTelefones(pessoa.Telefones);
        },
        failure:function(r){
          $btn.btnload("unload");
          System.showError(r);
        }
      });

    });

    $(".telefone-add").find('input').on('keyup', function(event){
      if (event.keyCode === 13) $(".telefone-add").find('.btn-success').trigger('click');
    });

    // adicionar email
    $(".email-add [name=idcontatosubtipo]").combobox({
      url:PATH+"/contatossubtipos?idcontatotipo=1",
      displayField:"descontatosubtipo",
      valueField:"idcontatosubtipo",
      emptyText:"Selecione o tipo do email"
    });

    $(".email-add button").on("click", function(){

      var $form = $(".email-add");

      var $btn = $(this);

      $btn.btnload("load");

      rest({
        url:PATH+"/contatos",
        method:"POST",
        data:{
          idpessoa:pessoa.idpessoa,
          idcontato:0,
          idcontatotipo:1,
          idcontatosubtipo:$form.find("[name=idcontatosubtipo]").val(),
          descontato:$form.find("input").val(),
          inprincipal:0
        },
        success:function(r){
          $form.find("select, input").val('');
          $btn.btnload("unload");
          pessoa.Emails.push(r.data);
          renderEmails(pessoa.Emails);          
        },
        failure:function(r){
          $btn.btnload("unload");
          System.showError(r);
        }
      });

    });

    $(".email-add").find('input').on('keyup', function(event){
      if (event.keyCode === 13) $(".email-add").find('.btn-success').trigger('click');
    });

    // adicionar documentos
    $(".documento-add [name=iddocumentotipo]").combobox({
      url:PATH+"/documentos/tipos",
      displayField:"desdocumentotipo",
      valueField:"iddocumentotipo",
      emptyText:"Selecione o tipo do documento"
    });

    $(".documento-add button").on("click", function(){

      var $form = $(".documento-add");

      var $btn = $(this);

      $btn.btnload("load");

      rest({
        url:PATH+"/documentos",
        method:"POST",
        data:{
          idpessoa:pessoa.idpessoa,
          iddocumento:0,
          iddocumentotipo:$form.find("[name=iddocumentotipo]").val(),
          desdocumento:$form.find("input").val()
        },
        success:function(r){
          $form.find("select, input").val('');
          $btn.btnload("unload");
          pessoa.Documentos.push(r.data);
          renderDocumentos(pessoa.Documentos);
        },
        failure:function(r){
          $btn.btnload("unload");
          System.showError(r);
        }
      });

    });

    $(".documento-add").find("input").on("keyup", function(event){
      if(event.keyCode === 13) $(".documento-add").find(".btn-success").trigger("click");
    });

    // salvar pessoa
    $("#pessoa-form").form({
      url:PATH+"/pessoas",
      resetForm:false,
      params:{
        idpessoa:pessoa.idpessoa
      },
      success:function(r){
        System.success("Pessoa salva com sucesso");
      }
    });

    var isSiteLogged = false;
    var isCartaoLogged = false;
    var isCarrinhoLogged = false;

    $("[name=idpessoatipo]").combobox({
      url:PATH+"/pessoastipos",
      displayField:"despessoatipo",
      valueField:"idpessoatipo",
      value:pessoa.idpessoatipo
    });

    $(".tab-pane .refresh").css({
      "position":"initial",
      "float":"right"
    });

    // $("a.nav-link[href='#cartoesTab']").on("shown.bs.tab", function(){
    //   loadCartoes();
    // });

    // $("a.nav-link[href='#siteContatosTab']").on("shown.bs.tab", function(){
    //   loadSites();
    // });

    // $("a.nav-link[href='#carrinhosTab']").on("shown.bs.tab", function(){
    //   loadCarrinhos();
    // });

    // function loadCartoes(json){

    //   if(isCartaoLogged === false){

    //     $("#cartoesTab .refresh").on("click", function(){

    //       isCartaoLogged = false;

    //       rest({
    //         url:PATH+"/pessoas/"+pessoa.idpessoa+"/cartoes",
    //         success:function(r){
    //           loadCartoes(r);
    //         },
    //         failure:function(r){
    //           console.error(r);
    //         }
    //       });

    //     });

    //     var $panelCartoes = System.getPanelApi($(".panel-cartoes"));

    //     var $tbody = $("#cartoesTab tbody")

    //     $tbody.html('');

    //     var $tplCartoes = Handlebars.compile($("#tpl-cartao-pessoa").html());    

    //     $panelCartoes.load();

    //     if(!json){
    //       var r = pessoa.Cartoes;
    //     }else{
    //       var r = json.data;
    //     }

    //     $.each(r, function(index, row){
    //       $tbody.append($tplCartoes(row));
    //     });        

    //     $panelCartoes.load();
    //     $panelCartoes.done();

    //     isCartaoLogged = true;

    //   }

    // }

    // function loadSites(json){

    //   if(isSiteLogged === false){

    //     var $tbody = $("#siteContatosTab tbody")

    //     $tbody.html('');

    //     $tplSites = Handlebars.compile($("#tpl-site-contato-pessoa").html());

    //     $panelSite = System.getPanelApi($(".panel-site-contatos"));

    //     $panelSite.load();

    //     if(!json){
    //       var r = pessoa.SiteContatos;
    //     }else{
    //       var r = json.data;
    //     }

    //     $.each(r, function(index, row){
    //       $tbody.append($tplSites(row));
    //     });

    //     $panelSite.done();

    //     isSiteLogged = true;

    //   }

    // }

    // function loadCarrinhos(json){

    //   if(isCarrinhoLogged === false){

    //     var $tbody = $("#carrinhosTab tbody");

    //     $tbody.html('');

    //     var $tplCarrinhos = Handlebars.compile($("#tpl-carrinho-pessoa").html());

    //     $panelCarrinhos = System.getPanelApi($(".panel-carrinhos"));

    //     $panelCarrinhos.load();

    //     if(!json){
    //       var r = pessoa.Carrinhos;
    //     }else{
    //       var r = json.data;
    //     }

    //     $.each(r, function(index, row){
    //       $tbody.append($tplCarrinhos(row));
    //     });

    //     $panelCarrinhos.done();

    //     isCarrinhoLogged = true;

    //   }

    // }

})();</script>